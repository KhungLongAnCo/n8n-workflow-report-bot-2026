{
  "name": "24-2 miku bot 2",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "b287a9a4-cfe2-4210-b7ae-6ddae6dc30bd",
      "name": "â° 8AM Daily Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -480,
        160
      ]
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "12cb7687-fefd-41fb-b8d7-eee883129bcc",
      "name": "âœˆï¸ Telegram Chat Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        -480,
        576
      ],
      "webhookId": "luanluan-tg-webhook",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/"
            }
          ]
        }
      },
      "id": "77fc15f1-50b5-45f2-a555-00c05d467df7",
      "name": "Is Command?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -240,
        576
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.message.text.split(' ')[0] }}",
        "rules": {
          "rules": [
            {
              "value2": "/report-all"
            },
            {
              "value2": "/check-web"
            },
            {
              "value2": "/emails"
            },
            {
              "value2": "/help"
            }
          ]
        },
        "fallbackOutput": 3
      },
      "id": "95a1e9b7-2fd5-4c58-9637-5d1087122a44",
      "name": "ğŸ”€ Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        0,
        576
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "filters": {
          "readStatus": "unread"
        }
      },
      "id": "e8370a6f-dfed-461b-a2f3-bb397d0ac1d2",
      "name": "ğŸ“§ Read Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        -240,
        160
      ],
      "webhookId": "10c4da68-b700-4b26-a35b-cea81b3fc3d1",
      "credentials": {
        "gmailOAuth2": {
          "id": "R7SnrySmJefhx4d0",
          "name": "Gmail account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "1008651619",
        "text": "âš ï¸ *Lá»—i Ä‘á»c Gmail*\n\nKhÃ´ng thá»ƒ káº¿t ná»‘i hoáº·c Ä‘á»c email\\.\nVui lÃ²ng kiá»ƒm tra:\nâ€¢ Credential Gmail cÃ²n há»£p lá»‡ khÃ´ng?\nâ€¢ OAuth2 token Ä‘Ã£ háº¿t háº¡n?\n\n`Lá»—i: {{ $json.error?.message || 'Unknown error' }}`",
        "additionalFields": {
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "76f1a6bd-321c-445d-bf9a-a18dd6d44b85",
      "name": "ğŸ“§âŒ Gmail Error Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "webhookId": "090672f4-07b8-4e54-9f5f-d476ab4036c4",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Gom táº¥t cáº£ email thÃ nh 1 item Ä‘á»ƒ gá»­i batch vÃ o AI\nconst emails = $input.all().map(item => ({\n  id:      item.json.id,\n  from:    item.json.from,\n  subject: item.json.subject,\n  snippet: item.json.snippet || item.json.text?.substring(0, 300) || ''\n}));\n\nreturn [{ json: { emails, count: emails.length } }];"
      },
      "id": "c1ae4b33-ae70-46f8-877d-6779bf4b29d4",
      "name": "Prepare Email Batch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        160
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "Báº¡n lÃ  email assistant. PhÃ¢n loáº¡i má»—i email vÃ o:\n- reply_needed: email tá»« ngÆ°á»i tháº­t, cáº§n tráº£ lá»i\n- advertisement: marketing, newsletter, promo, sale\n- fyi: thÃ´ng bÃ¡o, invoice, notification tá»± Ä‘á»™ng\n- spam: rÃ¡c, khÃ´ng liÃªn quan\n\nTráº£ vá» JSON array (KHÃ”NG cÃ³ markdown, chá»‰ JSON thuáº§n):\n[{\"id\": \"...\", \"from\": \"...\", \"subject\": \"...\", \"category\": \"reply_needed\", \"summary_vi\": \"tÃ³m táº¯t tiáº¿ng Viá»‡t ngáº¯n gá»n\", \"priority\": \"high|medium|low\"}]",
              "role": "system"
            },
            {
              "content": "=Emails to classify:\n{{ JSON.stringify($json.emails, null, 2) }}"
            }
          ]
        },
        "options": {
          "maxTokens": 10000,
          "temperature": 0.1
        }
      },
      "id": "bddbb33c-eb3b-4374-957e-3839a446be71",
      "name": "ğŸ¤– AI Classify Emails",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [
        240,
        160
      ],
      "credentials": {
        "openAiApi": {
          "id": "JkzyiYOViURlWSyr",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "HEAD",
        "url": "https://luanluan.tech",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          },
          "timeout": 10000
        }
      },
      "id": "5197fc57-7c38-4b94-8e22-c47478bbebdb",
      "name": "ğŸŒ Check luanluan.tech",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        480,
        160
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// â”€â”€ Láº¥y AI classification result â”€â”€\nlet classified = [];\ntry {\n  const aiItems = $('ğŸ¤– AI Classify Emails').all();\n  \n  // n8n OpenAI node returns: [{ json: { index, message: { content: \"...\" }, finish_reason } }]\n  const raw = aiItems[0]?.json?.message?.content\n           || aiItems[0]?.json?.content\n           || aiItems[0]?.json?.text\n           || '[]';\n\n  // Warn if response was cut off\n  const finishReason = aiItems[0]?.json?.finish_reason;\n  if (finishReason === 'length') {\n    // Truncated â€” try to salvage valid portion\n    const lastBracket = raw.lastIndexOf('}');\n    const salvaged = lastBracket !== -1 ? raw.substring(0, lastBracket + 1) + ']' : '[]';\n    const cleaned = salvaged.replace(/```json\\n?|```/g, '').trim();\n    classified = JSON.parse(cleaned);\n  } else {\n    const cleaned = raw.replace(/```json\\n?|```/g, '').trim();\n    classified = JSON.parse(cleaned);\n  }\n} catch(e) {\n  classified = [];\n}\n\n// â”€â”€ Láº¥y site status â”€â”€\nconst allItems = $input.all();\nconst siteRaw = allItems[0]?.json;\nconst siteData = Array.isArray(siteRaw) ? siteRaw[0] : siteRaw;\n\nlet siteStatus;\nif (!siteData) {\n  siteStatus = 'ğŸ”´ OFFLINE\\n   `KhÃ´ng nháº­n Ä‘Æ°á»£c pháº£n há»“i`';\n} else if (siteData.error || (!siteData.statusCode && siteData.code)) {\n  const reason = (siteData.error?.message || siteData.message || 'timeout/unreachable').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  siteStatus = `ğŸ”´ OFFLINE\\n   \\`${reason}\\``;\n} else if (siteData.statusCode >= 200 && siteData.statusCode < 400) {\n  siteStatus = `âœ… ONLINE \\\\(${siteData.statusCode}\\\\)`;\n} else {\n  siteStatus = `âš ï¸ Lá»—i HTTP ${siteData.statusCode || 'unknown'}`;\n}\n\nconst replyNeeded = classified.filter(m => m.category === 'reply_needed');\nconst ads         = classified.filter(m => m.category === 'advertisement');\nconst fyi         = classified.filter(m => m.category === 'fyi');\nconst spam        = classified.filter(m => m.category === 'spam');\n\nconst now = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });\nconst nowEscaped = now.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n\nlet msg = `ğŸ“Š *BÃO CÃO SÃNG â€” 08:00*\\n`;\nmsg += `\\`${nowEscaped}\\`\\n\\n`;\nmsg += `ğŸŒ *luanluan\\\\.tech:* ${siteStatus}\\n\\n`;\nmsg += `ğŸ“§ *Email hÃ´m nay: ${classified.length} má»›i*\\n`;\nmsg += `â”œ ğŸ’¬ Cáº§n reply: ${replyNeeded.length}\\n`;\nmsg += `â”œ ğŸ“¢ Quáº£ng cÃ¡o: ${ads.length}\\n`;\nmsg += `â”œ ğŸ“Œ FYI: ${fyi.length}\\n`;\nmsg += `â”” ğŸ—‘ï¸ Spam: ${spam.length}\\n`;\n\nif (replyNeeded.length > 0) {\n  msg += `\\n*ğŸ“Œ Cáº§n xá»­ lÃ½:*\\n`;\n  replyNeeded.slice(0, 5).forEach((m, i) => {\n    const icon = m.priority === 'high' ? 'ğŸ”´' : m.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';\n    const from    = (m.from    || '').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n    const summary = (m.summary_vi || m.subject || '').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n    msg += `${i+1}\\\\. ${icon} \\`${from}\\`\\n   ${summary}\\n`;\n  });\n  if (replyNeeded.length > 5) {\n    msg += `_\\\\.\\\\.\\\\.vÃ  ${replyNeeded.length - 5} email khÃ¡c_\\n`;\n  }\n}\n\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "d0921109-3129-4ef4-97ed-a953e6223082",
      "name": "ğŸ“ Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        160
      ]
    },
    {
      "parameters": {
        "chatId": "1008651619",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "18614ffe-cfe0-4677-a238-5d5df9b383b3",
      "name": "âœˆï¸ Send Morning Report",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        960,
        160
      ],
      "webhookId": "e3f0a5b4-abe5-4a91-85a1-7c798c5fabb4",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "method": "HEAD",
        "url": "https://luanluan.tech",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          },
          "timeout": 10000
        }
      },
      "id": "96622a12-c07f-47d6-b5ec-ef89d91903e1",
      "name": "ğŸŒ Check Site (cmd)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        272,
        688
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// â”€â”€ Xá»­ lÃ½ cáº£ 3 trÆ°á»ng há»£p: online / HTTP error / timeout+network error â”€â”€\nconst allItems = $input.all();\nconst raw = allItems[0]?.json;\n\n// Response is an array [{statusCode, headers, ...}], unwrap it safely\nconst d = Array.isArray(raw) ? raw[0] : raw;\n\nif (!d) {\n  return [{ json: { text: 'âŒ *Lá»—i*: KhÃ´ng nháº­n Ä‘Æ°á»£c dá»¯ liá»‡u pháº£n há»“i', parse_mode: 'MarkdownV2' } }];\n}\n\nconst url = 'https://luanluan.tech';\nconst urlEscaped = url.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n\nlet statusLine;\nif (d.error || d.code === 'ECONNREFUSED' || d.code === 'ETIMEDOUT' || d.code === 'ENOTFOUND') {\n  // Network-level error: timeout, DNS fail, connection refused...\n  const reason = d.error?.message || d.message || d.code || 'KhÃ´ng thá»ƒ káº¿t ná»‘i';\n  const reasonEscaped = reason.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  statusLine = `ğŸ”´ *OFFLINE*\\nğŸ” LÃ½ do: \\`${reasonEscaped}\\``;\n} else if (d.statusCode != null && d.statusCode >= 200 && d.statusCode < 400) {\n  // HTTP success\n  statusLine = `âœ… *ONLINE* \\\\(HTTP ${d.statusCode}\\\\)`;\n} else {\n  // HTTP error (5xx, 4xx...) or statusCode is missing\n  statusLine = `âš ï¸ *Lá»—i HTTP ${d.statusCode ?? 'unknown'}*\\nServer pháº£n há»“i nhÆ°ng cÃ³ lá»—i`;\n}\n\nconst msg = `ğŸŒ *Kiá»ƒm tra website*\\n${urlEscaped}\\n\\n${statusLine}`;\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "8abfe507-1bc0-4e5c-bf61-ba3c91f417ad",
      "name": "Format Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        688
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "25daef52-3c5d-4912-920f-60eef218078c",
      "name": "Reply /check",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        752,
        688
      ],
      "webhookId": "c4e416e8-7de0-406d-baa4-1fd74ca8a285",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "limit": 20,
        "filters": {
          "readStatus": "unread"
        }
      },
      "id": "eba02f14-6679-454f-a588-d81b18f50f85",
      "name": "ğŸ“§ Read Gmail (cmd)",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        272,
        464
      ],
      "webhookId": "5dbae2f5-1376-49b6-8ee3-0e249b5e9710",
      "credentials": {
        "gmailOAuth2": {
          "id": "R7SnrySmJefhx4d0",
          "name": "Gmail account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Kiá»ƒm tra náº¿u cÃ³ lá»—i (error output tá»« Gmail node)\nconst items = $input.all();\nconst d = items[0]?.json;\n\nif (d.error || d.message?.includes('Error') || d.name === 'NodeOperationError') {\n  return [{ json: {\n    text: `âš ï¸ *KhÃ´ng thá»ƒ Ä‘á»c email*\\n\\nLá»—i káº¿t ná»‘i Gmail\\. Vui lÃ²ng kiá»ƒm tra credential\\.\\n\\`${(d.error?.message || d.message || 'Unknown error').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&')}\\``,\n    parse_mode: 'MarkdownV2'\n  }}];\n}\n\n// Náº¿u khÃ´ng cÃ³ email nÃ o\nif (items.length === 0 || !items[0].json.id) {\n  return [{ json: {\n    text: `ğŸ“­ *KhÃ´ng cÃ³ email má»›i*\\nInbox trá»‘ng trong 24h qua\\.`,\n    parse_mode: 'MarkdownV2'\n  }}];\n}\n\n// Build email list\nlet msg = `ğŸ“§ *Email chÆ°a Ä‘á»c \\(${items.length}\\)*\\n\\n`;\nitems.slice(0, 10).forEach((item, i) => {\n  const from    = (item.json.from    || 'unknown').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  const subject = (item.json.subject || '(no subject)').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  msg += `${i+1}\\. ğŸ“¨ \\`${from}\\`\\n   ${subject}\\n`;\n});\nif (items.length > 10) msg += `_\\.\\.\\.vÃ  ${items.length - 10} email khÃ¡c_`;\n\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "6c272a9d-6bbd-4ed2-b510-e2ffcbe1b0cf",
      "name": "Format Emails List",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        464
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "f115e459-5bd8-4f83-9e05-48706e6e4cc9",
      "name": "Reply /emails",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        752,
        464
      ],
      "webhookId": "a283888d-964f-48ca-9320-d1cb41b9c999",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "=â„¹ï¸ *CÃ¡c lá»‡nh cÃ³ thá»ƒ dÃ¹ng:*\n\n`/report-all` â€” Xem bÃ¡o cÃ¡o email ngay bÃ¢y giá»\n`/check-web` â€” Kiá»ƒm tra luanluan\\.tech\n`/emails` â€” Xem danh sÃ¡ch email chÆ°a Ä‘á»c\n`/help` â€” Hiá»‡n menu nÃ y",
        "additionalFields": {
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "bbf8c3c7-0475-42f6-9861-d17c08e54e73",
      "name": "Reply /help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        752,
        336
      ],
      "webhookId": "b1419e67-0673-45eb-ac57-605dd90ea2d8",
      "credentials": {
        "telegramApi": {
          "id": "hqZpXp6kQO5lnHpp",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "â° 8AM Daily Trigger": {
      "main": [
        [
          {
            "node": "ğŸ“§ Read Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Read Gmail": {
      "main": [
        [
          {
            "node": "Prepare Email Batch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“§âŒ Gmail Error Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Email Batch": {
      "main": [
        [
          {
            "node": "ğŸ¤– AI Classify Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– AI Classify Emails": {
      "main": [
        [
          {
            "node": "ğŸŒ Check luanluan.tech",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Check luanluan.tech": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“ Format Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Report": {
      "main": [
        [
          {
            "node": "âœˆï¸ Send Morning Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœˆï¸ Telegram Chat Trigger": {
      "main": [
        [
          {
            "node": "Is Command?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Command?": {
      "main": [
        [
          {
            "node": "ğŸ”€ Route Command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply /help",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Route Command": {
      "main": [
        [
          {
            "node": "ğŸ“§ Read Gmail",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸŒ Check Site (cmd)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“§ Read Gmail (cmd)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply /help",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Check Site (cmd)": {
      "main": [
        [
          {
            "node": "Format Check Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Check Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Check Result": {
      "main": [
        [
          {
            "node": "Reply /check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Read Gmail (cmd)": {
      "main": [
        [
          {
            "node": "Format Emails List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Emails List": {
      "main": [
        [
          {
            "node": "Reply /emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "90dd7965-fcda-44da-a0aa-bbde421706b1",
  "meta": {
    "instanceId": "14a38fd09c7ede96f5189d440ee3eaefeae9462b0865b74cb867ca065f54e3c2"
  },
  "id": "U0zIVEHZtgDYps2F",
  "tags": []
}