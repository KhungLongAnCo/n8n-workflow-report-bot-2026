{
  "name": "luanluan-assistant",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "cron-morning",
      "name": "â° 8AM Daily Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [0, 300]
    },
    {
      "parameters": {
        "updates": ["message"],
        "additionalFields": {}
      },
      "id": "tg-trigger",
      "name": "âœˆï¸ Telegram Chat Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [0, 700],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      },
      "webhookId": "luanluan-tg-webhook"
    },

    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/"
            }
          ]
        }
      },
      "id": "check-command",
      "name": "Is Command?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [240, 700]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.message.text.split(' ')[0] }}",
        "rules": {
          "rules": [
            { "value2": "/report", "output": 0 },
            { "value2": "/check", "output": 1 },
            { "value2": "/emails", "output": 2 },
            { "value2": "/help", "output": 3 }
          ]
        },
        "fallbackOutput": 3
      },
      "id": "command-router",
      "name": "ğŸ”€ Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [480, 700]
    },

    {
      "parameters": {
        "operation": "getAll",
        "returnAll": false,
        "limit": 50,
        "filters": {
          "readStatus": "unread",
          "query": "is:unread newer_than:1d -category:social -category:forums"
        },
        "options": { "format": "resolved" }
      },
      "id": "read-gmail",
      "name": "ğŸ“§ Read Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [240, 300],
      "onError": "continueErrorOutput",
      "credentials": {
        "gmailOAuth2": { "id": "gmail-cred", "name": "Gmail OAuth2" }
      }
    },

    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "âš ï¸ *Lá»—i Ä‘á»c Gmail*\n\nKhÃ´ng thá»ƒ káº¿t ná»‘i hoáº·c Ä‘á»c email\\.\nVui lÃ²ng kiá»ƒm tra:\nâ€¢ Credential Gmail cÃ²n há»£p lá»‡ khÃ´ng?\nâ€¢ OAuth2 token Ä‘Ã£ háº¿t háº¡n?\n\n`Lá»—i: {{ $json.error?.message || 'Unknown error' }}`",
        "additionalFields": { "parse_mode": "MarkdownV2" }
      },
      "id": "gmail-error-notify",
      "name": "ğŸ“§âŒ Gmail Error Notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [480, 140],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      }
    },

    {
      "parameters": {
        "jsCode": "// Gom táº¥t cáº£ email thÃ nh 1 item Ä‘á»ƒ gá»­i batch vÃ o AI\nconst emails = items.map(item => ({\n  id:      item.json.id,\n  from:    item.json.from,\n  subject: item.json.subject,\n  snippet: item.json.snippet || item.json.text?.substring(0, 300) || ''\n}));\n\nreturn [{ json: { emails, count: emails.length } }];"
      },
      "id": "prep-emails",
      "name": "Prepare Email Batch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300]
    },

    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "Báº¡n lÃ  email assistant. PhÃ¢n loáº¡i má»—i email vÃ o:\n- reply_needed: email tá»« ngÆ°á»i tháº­t, cáº§n tráº£ lá»i\n- advertisement: marketing, newsletter, promo, sale\n- fyi: thÃ´ng bÃ¡o, invoice, notification tá»± Ä‘á»™ng\n- spam: rÃ¡c, khÃ´ng liÃªn quan\n\nTráº£ vá» JSON array (KHÃ”NG cÃ³ markdown, chá»‰ JSON thuáº§n):\n[{\"id\": \"...\", \"from\": \"...\", \"subject\": \"...\", \"category\": \"reply_needed\", \"summary_vi\": \"tÃ³m táº¯t tiáº¿ng Viá»‡t ngáº¯n gá»n\", \"priority\": \"high|medium|low\"}]"
            },
            {
              "role": "user",
              "content": "=Emails to classify:\n{{ JSON.stringify($json.emails, null, 2) }}"
            }
          ]
        },
        "options": { "maxTokens": 2000, "temperature": 0.1 }
      },
      "id": "ai-classify",
      "name": "ğŸ¤– AI Classify Emails",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [720, 300],
      "credentials": {
        "openAiApi": { "id": "openai-cred", "name": "OpenAI" }
      }
    },

    {
      "parameters": {
        "url": "={{ $env.MONITOR_URL || 'https://luanluan.tech' }}",
        "options": {
          "timeout": 10000,
          "response": { "response": { "fullResponse": true } }
        }
      },
      "id": "check-site",
      "name": "ğŸŒ Check luanluan.tech",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [960, 300],
      "onError": "continueErrorOutput"
    },

    {
      "parameters": {
        "jsCode": "// â”€â”€ Láº¥y AI classification result â”€â”€\nlet classified = [];\ntry {\n  // TÃ¬m output tá»« AI node trong execution context\n  const aiRaw = $('ğŸ¤– AI Classify Emails').item?.json;\n  const raw = aiRaw?.message?.content\n           || aiRaw?.choices?.[0]?.message?.content\n           || '[]';\n  // Strip markdown code fences náº¿u model tráº£ vá»\n  const cleaned = raw.replace(/```json\\n?|```/g, '').trim();\n  classified = JSON.parse(cleaned);\n} catch(e) {\n  classified = [];\n}\n\n// â”€â”€ Láº¥y site status â”€â”€\n// items[0] lÃ  tá»« check-site (main hoáº·c error output)\nconst siteData = items[0].json;\nlet siteStatus;\n\n// Khi timeout/network error: siteData.error tá»“n táº¡i, khÃ´ng cÃ³ statusCode\nif (siteData.error || (!siteData.statusCode && siteData.code)) {\n  const reason = siteData.error?.message || siteData.message || 'timeout/unreachable';\n  siteStatus = `ğŸ”´ OFFLINE\\n   \\`${reason}\\``;\n} else if (siteData.statusCode >= 200 && siteData.statusCode < 400) {\n  siteStatus = `âœ… ONLINE \\(${siteData.statusCode}\\)`;\n} else {\n  siteStatus = `âš ï¸ Lá»—i HTTP ${siteData.statusCode || 'unknown'}`;\n}\n\nconst replyNeeded = classified.filter(m => m.category === 'reply_needed');\nconst ads         = classified.filter(m => m.category === 'advertisement');\nconst fyi         = classified.filter(m => m.category === 'fyi');\nconst spam        = classified.filter(m => m.category === 'spam');\n\nconst now = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });\n// Escape MarkdownV2 special chars in timestamp\nconst nowEscaped = now.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n\nlet msg = `ğŸ“Š *BÃO CÃO SÃNG â€” 08:00*\\n`;\nmsg += `\\`${nowEscaped}\\`\\n\\n`;\nmsg += `ğŸŒ *luanluan\\.tech:* ${siteStatus}\\n\\n`;\nmsg += `ğŸ“§ *Email hÃ´m nay: ${classified.length} má»›i*\\n`;\nmsg += `â”œ ğŸ’¬ Cáº§n reply: ${replyNeeded.length}\\n`;\nmsg += `â”œ ğŸ“¢ Quáº£ng cÃ¡o: ${ads.length}\\n`;\nmsg += `â”œ ğŸ“Œ FYI: ${fyi.length}\\n`;\nmsg += `â”” ğŸ—‘ï¸ Spam: ${spam.length}\\n`;\n\nif (replyNeeded.length > 0) {\n  msg += `\\n*ğŸ“Œ Cáº§n xá»­ lÃ½:*\\n`;\n  replyNeeded.slice(0, 5).forEach((m, i) => {\n    const icon = m.priority === 'high' ? 'ğŸ”´' : m.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';\n    const from    = (m.from    || '').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n    const summary = (m.summary_vi || m.subject || '').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n    msg += `${i+1}\\. ${icon} \\`${from}\\`\\n   ${summary}\\n`;\n  });\n  if (replyNeeded.length > 5) {\n    msg += `_\\.\\.\\.vÃ  ${replyNeeded.length - 5} email khÃ¡c_\\n`;\n  }\n}\n\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "format-report",
      "name": "ğŸ“ Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },

    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.text }}",
        "additionalFields": { "parse_mode": "MarkdownV2" }
      },
      "id": "send-report",
      "name": "âœˆï¸ Send Morning Report",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1440, 300],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      }
    },

    {
      "parameters": {
        "url": "={{ $env.MONITOR_URL || 'https://luanluan.tech' }}",
        "options": {
          "timeout": 10000,
          "response": { "response": { "fullResponse": true } }
        }
      },
      "id": "check-site-cmd",
      "name": "ğŸŒ Check Site (cmd)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [760, 820],
      "onError": "continueErrorOutput"
    },

    {
      "parameters": {
        "jsCode": "// â”€â”€ Xá»­ lÃ½ cáº£ 3 trÆ°á»ng há»£p: online / HTTP error / timeout+network error â”€â”€\nconst d   = items[0].json;\nconst url = process.env.MONITOR_URL || 'https://luanluan.tech';\nconst urlEscaped = url.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n\nlet statusLine;\n\nif (d.error || d.code === 'ECONNREFUSED' || d.code === 'ETIMEDOUT' || d.code === 'ENOTFOUND') {\n  // Network-level error: timeout, DNS fail, connection refusedâ€¦\n  const reason = d.error?.message || d.message || d.code || 'KhÃ´ng thá»ƒ káº¿t ná»‘i';\n  const reasonEscaped = reason.replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  statusLine = `ğŸ”´ *OFFLINE*\\nğŸ” LÃ½ do: \\`${reasonEscaped}\\``;\n\n} else if (d.statusCode >= 200 && d.statusCode < 400) {\n  // HTTP success\n  statusLine = `âœ… *ONLINE* \\(HTTP ${d.statusCode}\\)`;\n\n} else {\n  // HTTP error (5xx, 4xxâ€¦)\n  statusLine = `âš ï¸ *Lá»—i HTTP ${d.statusCode || 'unknown'}*\\nServer pháº£n há»“i nhÆ°ng cÃ³ lá»—i`;\n}\n\nconst msg = `ğŸŒ *Kiá»ƒm tra website*\\n${urlEscaped}\\n\\n${statusLine}`;\n\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "format-check",
      "name": "Format Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 820]
    },

    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.text }}",
        "additionalFields": { "parse_mode": "MarkdownV2" }
      },
      "id": "reply-check",
      "name": "Reply /check",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1240, 820],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      }
    },

    {
      "parameters": {
        "operation": "getAll",
        "returnAll": false,
        "limit": 20,
        "filters": {
          "readStatus": "unread",
          "query": "is:unread newer_than:1d"
        },
        "options": { "format": "resolved" }
      },
      "id": "read-gmail-cmd",
      "name": "ğŸ“§ Read Gmail (cmd)",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [760, 600],
      "onError": "continueErrorOutput",
      "credentials": {
        "gmailOAuth2": { "id": "gmail-cred", "name": "Gmail OAuth2" }
      }
    },

    {
      "parameters": {
        "jsCode": "// Kiá»ƒm tra náº¿u cÃ³ lá»—i (error output tá»« Gmail node)\nconst d = items[0].json;\nif (d.error || d.message?.includes('Error') || d.name === 'NodeOperationError') {\n  return [{ json: {\n    text: `âš ï¸ *KhÃ´ng thá»ƒ Ä‘á»c email*\\n\\nLá»—i káº¿t ná»‘i Gmail\\. Vui lÃ²ng kiá»ƒm tra credential\\.\\n\\`${(d.error?.message || d.message || 'Unknown error').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&')}\\``,\n    parse_mode: 'MarkdownV2'\n  }}];\n}\n\n// Náº¿u khÃ´ng cÃ³ email nÃ o\nif (items.length === 0 || !items[0].json.id) {\n  return [{ json: {\n    text: `ğŸ“­ *KhÃ´ng cÃ³ email má»›i*\\nInbox trá»‘ng trong 24h qua\\.`,\n    parse_mode: 'MarkdownV2'\n  }}];\n}\n\n// Build email list\nlet msg = `ğŸ“§ *Email chÆ°a Ä‘á»c \\(${items.length}\\)*\\n\\n`;\nitems.slice(0, 10).forEach((item, i) => {\n  const from    = (item.json.from    || 'unknown').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  const subject = (item.json.subject || '(no subject)').replace(/[_*[\\]()~>#+=|{}.!-]/g, '\\\\$&');\n  msg += `${i+1}\\. ğŸ“¨ \\`${from}\\`\\n   ${subject}\\n`;\n});\nif (items.length > 10) msg += `_\\.\\.\\.vÃ  ${items.length - 10} email khÃ¡c_`;\n\nreturn [{ json: { text: msg, parse_mode: 'MarkdownV2' } }];"
      },
      "id": "format-emails-cmd",
      "name": "Format Emails List",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 600]
    },

    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.text }}",
        "additionalFields": { "parse_mode": "MarkdownV2" }
      },
      "id": "reply-emails",
      "name": "Reply /emails",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1240, 600],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      }
    },

    {
      "parameters": {
        "chatId": "={{ $('âœˆï¸ Telegram Chat Trigger').item.json.message.chat.id }}",
        "text": "â„¹ï¸ *CÃ¡c lá»‡nh cÃ³ thá»ƒ dÃ¹ng:*\n\n`/report` â€” Xem bÃ¡o cÃ¡o email ngay bÃ¢y giá»\n`/check` â€” Kiá»ƒm tra luanluan\\.tech\n`/emails` â€” Xem danh sÃ¡ch email chÆ°a Ä‘á»c\n`/help` â€” Hiá»‡n menu nÃ y",
        "additionalFields": { "parse_mode": "MarkdownV2" }
      },
      "id": "reply-help",
      "name": "Reply /help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1240, 480],
      "credentials": {
        "telegramApi": { "id": "tg-cred", "name": "Telegram Bot" }
      }
    }
  ],

  "connections": {
    "â° 8AM Daily Trigger": {
      "main": [[{ "node": "ğŸ“§ Read Gmail", "type": "main", "index": 0 }]]
    },

    "ğŸ“§ Read Gmail": {
      "main": [[{ "node": "Prepare Email Batch", "type": "main", "index": 0 }]],
      "error": [
        [{ "node": "ğŸ“§âŒ Gmail Error Notify", "type": "main", "index": 0 }]
      ]
    },

    "Prepare Email Batch": {
      "main": [
        [{ "node": "ğŸ¤– AI Classify Emails", "type": "main", "index": 0 }]
      ]
    },
    "ğŸ¤– AI Classify Emails": {
      "main": [
        [{ "node": "ğŸŒ Check luanluan.tech", "type": "main", "index": 0 }]
      ]
    },

    "ğŸŒ Check luanluan.tech": {
      "main": [[{ "node": "ğŸ“ Format Report", "type": "main", "index": 0 }]],
      "error": [[{ "node": "ğŸ“ Format Report", "type": "main", "index": 0 }]]
    },

    "ğŸ“ Format Report": {
      "main": [
        [{ "node": "âœˆï¸ Send Morning Report", "type": "main", "index": 0 }]
      ]
    },

    "âœˆï¸ Telegram Chat Trigger": {
      "main": [[{ "node": "Is Command?", "type": "main", "index": 0 }]]
    },
    "Is Command?": {
      "main": [
        [{ "node": "ğŸ”€ Route Command", "type": "main", "index": 0 }],
        [{ "node": "Reply /help", "type": "main", "index": 0 }]
      ]
    },
    "ğŸ”€ Route Command": {
      "main": [
        [{ "node": "ğŸ“§ Read Gmail", "type": "main", "index": 0 }],
        [{ "node": "ğŸŒ Check Site (cmd)", "type": "main", "index": 0 }],
        [{ "node": "ğŸ“§ Read Gmail (cmd)", "type": "main", "index": 0 }],
        [{ "node": "Reply /help", "type": "main", "index": 0 }]
      ]
    },

    "ğŸŒ Check Site (cmd)": {
      "main": [[{ "node": "Format Check Result", "type": "main", "index": 0 }]],
      "error": [[{ "node": "Format Check Result", "type": "main", "index": 0 }]]
    },
    "Format Check Result": {
      "main": [[{ "node": "Reply /check", "type": "main", "index": 0 }]]
    },

    "ğŸ“§ Read Gmail (cmd)": {
      "main": [[{ "node": "Format Emails List", "type": "main", "index": 0 }]],
      "error": [[{ "node": "Format Emails List", "type": "main", "index": 0 }]]
    },
    "Format Emails List": {
      "main": [[{ "node": "Reply /emails", "type": "main", "index": 0 }]]
    }
  },

  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Ho_Chi_Minh"
  },
  "tags": [{ "name": "luanluan-assistant" }]
}
